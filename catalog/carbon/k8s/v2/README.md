# Carbon v2 Processing Notes

Source: Zenodo 17645053 (2025 release)  
Bucket: `public-carbon`, prefix `v2/`

## Processing Steps

### 1. COG Preprocessing (custom — not generated by cng-datasets)
`preprocess-cogs.yaml` / `individual-cog-jobs/` — downloads source TIFFs from Zenodo and converts to ZSTD Cloud-Optimized GeoTIFFs in `public-carbon/v2/cogs/`.

This step is required before running the hex workflows because `cng-datasets raster-workflow` reads from S3, not directly from Zenodo.

`irrecoverable_c_total_2010.tif` is **absent** — the Zenodo source file has a corrupt TIFF IFD at offset 2448179594. See `irrecoverable-2010-gdal-bug.md` for details and minimal reproduction.

### 2. Hex Workflows (generated by cng-datasets raster-workflow)
Ten per-dataset directories (`{dataset}/`) each contain the generated workflow YAML.  
H3 resolution 8, parent resolutions 0.

### 3. Move to v2/ prefix (one-time — custom)
`move-hex-to-v2.yaml` — relocates hex outputs from `public-carbon/{dataset}/hex/` to `public-carbon/v2/{dataset}/hex/`.  
Required because `cng-datasets raster-workflow --dataset` does not support `/` in dataset names (causes FileNotFoundError when generating output directories). Once patched upstream this step will not be needed.

## Upstream Bugs Fixed During This Ingest

All fixes are in [`boettiger-lab/datasets`](https://github.com/boettiger-lab/datasets):

| Bug | Fix | Commit |
|-----|-----|--------|
| `PROJ_LIB` pointed to wrong path in container | Symlink to canonical path in Dockerfile | `4ae6242` |
| Preempted pods counted against `backoffLimit: 0` | Added `podFailurePolicy` with `DisruptionTarget: Ignore` | upstream |
| Hex output S3 keys had double-slash (`hex//h0=...`) | Fixed path join in raster output writer | upstream |

The `move-hex-to-v2.yaml` job uses `aws s3api list-objects` (not rclone) to copy objects with double-slash keys, since rclone silently skips them.
