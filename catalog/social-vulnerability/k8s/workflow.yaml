apiVersion: batch/v1
kind: Job
metadata:
  name: svi-2022-tract-workflow
  namespace: biodiversity
spec:
  template:
    spec:
      containers:
      - args:
        - "\nset -e\n\necho \"Starting svi-2022-tract workflow...\"\n\n# Step 0: Setup\
          \ bucket with public access and CORS\necho \"Step 0: Setting up bucket...\"\
          \nkubectl apply -f /yamls/setup-bucket-job.yaml -n biodiversity\n\necho\
          \ \"Waiting for bucket setup to complete...\"\nkubectl wait --for=condition=complete\
          \ --timeout=600s job/svi-2022-tract-setup-bucket -n biodiversity\n\n# Step\
          \ 1: Convert to optimized GeoParquet (needed by both pmtiles and hex jobs)\n\
          echo \"Step 1: Converting to optimized GeoParquet...\"\nkubectl apply -f\
          \ /yamls/convert-job.yaml -n biodiversity\n\necho \"Waiting for GeoParquet\
          \ conversion to complete...\"\nkubectl wait --for=condition=complete --timeout=3600s\
          \ job/svi-2022-tract-convert -n biodiversity\n\n# Step 2: Run pmtiles and\
          \ hex tiling in parallel (both use the converted geoparquet)\necho \"Step\
          \ 2: H3 hexagonal tiling and PMTiles generation (parallel)...\"\nkubectl\
          \ apply -f /yamls/pmtiles-job.yaml -n biodiversity\nkubectl apply -f /yamls/hex-job.yaml\
          \ -n biodiversity\n\necho \"Waiting for hex tiling to complete (PMTiles\
          \ continues in background)...\"\nkubectl wait --for=condition=complete --timeout=7200s\
          \ job/svi-2022-tract-hex -n biodiversity\n\necho \"Step 3: Repartitioning\
          \ by h0...\"\nkubectl apply -f /yamls/repartition-job.yaml -n biodiversity\n\
          \necho \"Waiting for repartition to complete...\"\nkubectl wait --for=condition=complete\
          \ --timeout=3600s job/svi-2022-tract-repartition -n biodiversity\n\necho\
          \ \"\u2713 Workflow complete!\"\necho \"Note: PMTiles job may still be running\
          \ in the background\"\necho \"\"\necho \"Clean up with:\"\necho \"  kubectl\
          \ delete jobs svi-2022-tract-setup-bucket svi-2022-tract-convert svi-2022-tract-pmtiles\
          \ svi-2022-tract-hex svi-2022-tract-repartition svi-2022-tract-workflow\
          \ -n biodiversity\"\necho \"  kubectl delete configmap svi-2022-tract-yamls\
          \ -n biodiversity\"\n"
        command:
        - bash
        - -c
        image: bitnami/kubectl:latest
        name: workflow
        resources:
          limits:
            cpu: 500m
            memory: 512Mi
          requests:
            cpu: 500m
            memory: 512Mi
        volumeMounts:
        - mountPath: /yamls
          name: yamls
      restartPolicy: OnFailure
      serviceAccountName: cng-datasets-workflow
      volumes:
      - configMap:
          name: svi-2022-tract-yamls
        name: yamls
  ttlSecondsAfterFinished: 10800
